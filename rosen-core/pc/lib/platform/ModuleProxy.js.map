{"version":3,"file":"ModuleProxy.js","sourceRoot":"","sources":["../../core/platform/ModuleProxy.tsx"],"names":[],"mappings":"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","sourcesContent":["import React from \"react\";\r\nimport { RouteComponentProps } from \"react-router\";\r\nimport { Location } from \"history\";\r\nimport { Module, ModuleLifecycleListener } from \"./Module\";\r\nimport { app } from \"../app\";\r\nimport { ActionCreators, ActionHandler, executeAction } from \"../module\";\r\n\r\nlet startupModuleName: string | null = null;\r\n\r\nfunction locationsAreEqual(a: Location, b: Location) {\r\n    return a.pathname === b.pathname && a.search === b.search && a.hash === b.hash && a.key === b.key && a.state === b.state;\r\n}\r\n\r\nexport const ModuleNameContext = React.createContext(null);\r\n\r\nexport class ModuleProxy<M extends Module<any, any>> {\r\n    constructor(private module: M, private actions: ActionCreators<M>) {}\r\n\r\n    getActions(): ActionCreators<M> {\r\n        return this.actions;\r\n    }\r\n\r\n    connect<P extends object>(ComponentType: React.ComponentType<P>): React.ComponentType<P> {\r\n        const moduleName = this.module.name;\r\n        const { initialState } = this.module;\r\n        const lifecycleListener = this.module as ModuleLifecycleListener;\r\n        const modulePrototype = Object.getPrototypeOf(lifecycleListener);\r\n        const actions = this.actions as any;\r\n\r\n        return class extends React.PureComponent<P> {\r\n            static displayName = `Module[${moduleName}]`;\r\n            private tickCount: number = 0;\r\n            private timer: NodeJS.Timeout | undefined;\r\n            constructor(props: P) {\r\n                super(props);\r\n                if (!startupModuleName) {\r\n                    startupModuleName = moduleName;\r\n                }\r\n            }\r\n\r\n            override componentDidMount() {\r\n                this.initialLifecycle();\r\n            }\r\n\r\n            override async componentDidUpdate(prevProps: Readonly<P>) {\r\n                const prevLocation = (prevProps as any).location;\r\n                const props = this.props as RouteComponentProps & P;\r\n                const currentLocation = props.location;\r\n                const currentRouteParams = props.match || null;\r\n                // console.log(\"-componentDidUpdate-\" + moduleName, prevProps, props);\r\n                if (currentLocation && currentRouteParams && !locationsAreEqual(currentLocation, prevLocation) && this.hasOwnLifecycle(\"onLocationMatched\")) {\r\n                    const actionName = `${moduleName}/@@LOCATION_MATCHED`;\r\n                    // const startTime = Date.now();\r\n                    await executeAction(\r\n                        actionName,\r\n                        lifecycleListener.onLocationMatched.bind(lifecycleListener) as ActionHandler,\r\n                        currentRouteParams,\r\n                        currentLocation\r\n                    );\r\n                }\r\n            }\r\n\r\n            override componentWillUnmount() {\r\n                if (this.hasOwnLifecycle(\"onDestroy\")) {\r\n                    app.store.dispatch(actions.onDestroy());\r\n                }\r\n\r\n                try {\r\n                    this.timer && clearTimeout(this.timer);\r\n                } catch {\r\n                    //\r\n                }\r\n            }\r\n\r\n            async initialLifecycle() {\r\n                const props = this.props as RouteComponentProps & P;\r\n\r\n                const enterActionName = `${moduleName}/@@ENTER`;\r\n                // const startTime = Date.now();\r\n                await executeAction(enterActionName, lifecycleListener.onEnter.bind(lifecycleListener), props?.match, props?.location);\r\n\r\n                if (this.hasOwnLifecycle(\"onLocationMatched\")) {\r\n                    if (\"match\" in props && \"location\" in props) {\r\n                        const initialRenderActionName = `${moduleName}/@@LOCATION_MATCHED`;\r\n                        // const startTime = Date.now();\r\n                        await executeAction(\r\n                            initialRenderActionName,\r\n                            lifecycleListener.onLocationMatched.bind(lifecycleListener) as ActionHandler,\r\n                            props.match,\r\n                            props.location\r\n                        );\r\n                    }\r\n                }\r\n\r\n                if (this.hasOwnLifecycle(\"onTick\")) {\r\n                    const tickIntervalInMillisecond = (lifecycleListener.onTick.tickInterval || 5) * 1000;\r\n                    const boundTicker = lifecycleListener.onTick.bind(lifecycleListener);\r\n                    const tickActionName = `${moduleName}/@@TICK`;\r\n\r\n                    while (true) {\r\n                        await executeAction(tickActionName, boundTicker);\r\n                        this.tickCount++;\r\n                        await new Promise((resolve, reject) => {\r\n                            this.timer = setTimeout(resolve, tickIntervalInMillisecond);\r\n                        });\r\n                    }\r\n                }\r\n            }\r\n\r\n            override render() {\r\n                return (\r\n                    <ModuleNameContext.Provider value={moduleName}>\r\n                        <ComponentType {...this.props} />\r\n                    </ModuleNameContext.Provider>\r\n                );\r\n            }\r\n\r\n            private hasOwnLifecycle = (methodName: keyof ModuleLifecycleListener): boolean => {\r\n                return Object.prototype.hasOwnProperty.call(modulePrototype, methodName);\r\n            };\r\n        };\r\n    }\r\n}\r\n"]}