{"version":3,"file":"error-util.js","sourceRoot":"","sources":["../../core/util/error-util.ts"],"names":[],"mappings":"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","sourcesContent":["import { isIEBrowser } from \"./navigator-util\";\r\nimport { app } from \"../app\";\r\nimport { Exception, JavaScriptException } from \"../Exception\";\r\nimport { ErrorHandler } from \"../module\";\r\nimport { GLOBAL_ERROR_ACTION, GLOBAL_PROMISE_REJECTION_ACTION } from \"../platform/bootstrap\";\r\n\r\nlet errorHandlerRunning = false;\r\n\r\ninterface ErrorExtra {\r\n    actionPayload?: string; // masked\r\n    extraStacktrace?: string;\r\n}\r\n\r\nexport function errorToException(error: unknown): Exception {\r\n    if (error instanceof Exception) {\r\n        return error;\r\n    } else {\r\n        let message: string;\r\n        if (!error) {\r\n            message = \"[No Message]\";\r\n        } else if (typeof error === \"string\") {\r\n            message = error;\r\n        } else if (error instanceof Error) {\r\n            message = error.message;\r\n        } else {\r\n            try {\r\n                message = JSON.stringify(error);\r\n            } catch (e) {\r\n                message = \"[Unknown]\";\r\n            }\r\n        }\r\n        return new JavaScriptException(message, error);\r\n    }\r\n}\r\n\r\nconst ignoreErrors = [\"ResizeObserver loop limit exceeded\"];\r\n\r\nexport function captureError(error: unknown, action: string = \"\", extra: ErrorExtra = {}): Exception {\r\n    const exception = errorToException(error);\r\n\r\n    const errorMessage = exception.message;\r\n    const ignore = ignoreErrors.find((errorKey) => errorMessage.includes(errorKey));\r\n    if (ignore) return;\r\n\r\n    if (process.env.NODE_ENV === \"development\") {\r\n        console.error(`[framework] Error captured from [${action}]`, error);\r\n    }\r\n\r\n    const errorStacktrace = error instanceof Error ? error.stack : undefined;\r\n    const errorCode = specialErrorCode(exception, action, errorStacktrace);\r\n    if (errorCode) {\r\n        // app.logger.warn({\r\n        //     action,\r\n        //     elapsedTime: 0,\r\n        //     info,\r\n        //     errorMessage: exception.message,\r\n        //     errorCode,\r\n        // });\r\n    } else {\r\n        runUserErrorHandler(app.errorHandler, exception);\r\n    }\r\n\r\n    return exception;\r\n}\r\n\r\nexport async function runUserErrorHandler(handler: ErrorHandler, exception: Exception) {\r\n    // For app, report errors to event server ASAP, in case of sudden termination\r\n    // sendEventLogs();\r\n    if (errorHandlerRunning) return;\r\n\r\n    try {\r\n        errorHandlerRunning = true;\r\n        await handler(exception);\r\n    } catch (e) {\r\n        console.warn(\"[framework] Fail to execute error handler\", e);\r\n    } finally {\r\n        errorHandlerRunning = false;\r\n    }\r\n}\r\n\r\nfunction specialErrorCode(exception: Exception, action: string, stacktrace?: string): string | null {\r\n    const errorMessage = exception.message.toLowerCase();\r\n    const ignoredPatterns = [\r\n        // Network error while downloading JavaScript/CSS (webpack async loading)\r\n        { pattern: \"loading chunk\", errorCode: \"JS_CHUNK\" },\r\n        { pattern: \"loading css chunk\", errorCode: \"CSS_CHUNK\" },\r\n        // CORS or CSP issues\r\n        { pattern: \"content security policy\", errorCode: \"CSP\" },\r\n        { pattern: \"script error\", errorCode: \"CORS\" },\r\n        // Vendor injected, mostly still with stacktrace\r\n        { pattern: \"ucbrowser\", errorCode: \"VENDOR\" },\r\n        { pattern: \"vivo\", errorCode: \"VENDOR\" },\r\n        { pattern: \"huawei\", errorCode: \"VENDOR\" },\r\n        // Browser sandbox issues\r\n        { pattern: \"the operation is insecure\", errorCode: \"BROWSER_LIMIT\" },\r\n        { pattern: \"access is denied for this document\", errorCode: \"BROWSER_LIMIT\" },\r\n    ];\r\n\r\n    if (isIEBrowser()) {\r\n        return \"IE_BROWSER_ISSUE\";\r\n    }\r\n\r\n    const matchedPattern = ignoredPatterns.find(({ pattern }) => errorMessage.includes(pattern));\r\n    if (matchedPattern) {\r\n        return `IGNORED_${matchedPattern.errorCode}_ISSUE`;\r\n    }\r\n    if (exception instanceof JavaScriptException && !isValidStacktrace(stacktrace) && [GLOBAL_ERROR_ACTION, GLOBAL_PROMISE_REJECTION_ACTION].includes(action)) {\r\n        return \"IGNORED_UNCATEGORIZED_ISSUE\";\r\n    }\r\n    if (action === GLOBAL_ERROR_ACTION && stacktrace && errorMessage.includes(\"'offsetwidth' of null\") && stacktrace.includes(\"Array.forEach\")) {\r\n        // This is a known Ant Design Tabs issue\r\n        return \"IGNORED_ANTD_TAB_ISSUE\";\r\n    }\r\n    if (action === GLOBAL_ERROR_ACTION && errorMessage.includes(\"'forcepopupalign' of null\")) {\r\n        // This is a known Ant Design Slider issue\r\n        return \"IGNORED_ANTD_SLIDER_ISSUE\";\r\n    }\r\n    return null;\r\n}\r\n\r\nfunction isValidStacktrace(stacktrace?: string): boolean {\r\n    if (stacktrace) {\r\n        const ignoredPatterns = [\"chrome-extension://\"];\r\n        if (ignoredPatterns.some((_) => stacktrace.includes(_))) {\r\n            return false;\r\n        }\r\n\r\n        /**\r\n         * Use fuzzy search, instead of document.querySelectorAll(\"script\") to get all script tag URLs.\r\n         *\r\n         * The reason is, in latest webpack, the code-split chunk script is just injected and then removed.\r\n         * In other words, the <script> tag only exists temporarily, not persisted in the DOM.\r\n         */\r\n        return stacktrace.includes(\".js\");\r\n    }\r\n    return false;\r\n}\r\n"]}