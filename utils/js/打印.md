```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>打印模板设计器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#64748B',
                        accent: '#F59E0B',
                        success: '#10B981',
                        danger: '#EF4444',
                    },
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                },
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .grid-bg {
                background-image: linear-gradient(#e5e7eb 1px, transparent 1px),
                                 linear-gradient(90deg, #e5e7eb 1px, transparent 1px);
                background-size: 20px 20px;
            }
            .resize-handle {
                @apply absolute w-3 h-3 bg-primary rounded-full border-2 border-white shadow-md z-10 cursor-pointer;
            }
            .resize-handle-tl { @apply top-0 left-0 transform -translate-x-1/2 -translate-y-1/2; }
            .resize-handle-tr { @apply top-0 right-0 transform translate-x-1/2 -translate-y-1/2; }
            .resize-handle-bl { @apply bottom-0 left-0 transform -translate-x-1/2 translate-y-1/2; }
            .resize-handle-br { @apply bottom-0 right-0 transform translate-x-1/2 translate-y-1/2; }
            .element-selected { @apply ring-2 ring-primary ring-opacity-50; }
        }
    </style>
</head>
<body class="font-inter bg-gray-50 text-gray-900 h-screen flex flex-col overflow-hidden">
    <!-- 顶部导航栏 -->
    <header class="bg-white border-b border-gray-200 shadow-sm z-50">
        <div class="max-w-full px-4 py-3 flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-2">
                    <i class="fa fa-file-text-o text-primary text-2xl"></i>
                    <h1 class="text-xl font-bold text-gray-800">打印模板设计器</h1>
                </div>
                <div class="hidden md:flex items-center space-x-2 text-sm text-gray-600">
                    <span class="bg-green-100 text-green-800 px-2 py-1 rounded">已保存</span>
                </div>
            </div>
            
            <div class="flex items-center space-x-3">
                <button id="undoBtn" class="p-2 text-gray-600 hover:text-primary hover:bg-gray-100 rounded-lg transition-colors">
                    <i class="fa fa-undo"></i>
                </button>
                <button id="redoBtn" class="p-2 text-gray-600 hover:text-primary hover:bg-gray-100 rounded-lg transition-colors">
                    <i class="fa fa-repeat"></i>
                </button>
                <div class="w-px h-6 bg-gray-300"></div>
                <button id="saveBtn" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                    <i class="fa fa-save mr-2"></i>保存模板
                </button>
                <button id="printBtn" class="px-4 py-2 bg-accent text-white rounded-lg hover:bg-accent/90 transition-colors">
                    <i class="fa fa-print mr-2"></i>打印预览
                </button>
            </div>
        </div>
    </header>

    <!-- 主内容区域 -->
    <div class="flex flex-1 overflow-hidden">
        <!-- 左侧工具栏 -->
        <aside class="w-64 bg-white border-r border-gray-200 shadow-sm overflow-y-auto">
            <!-- 基础图形 -->
            <div class="p-4 border-b border-gray-200">
                <h3 class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                    <i class="fa fa-th-large mr-2 text-secondary"></i>基础图形
                </h3>
                <div class="grid grid-cols-2 gap-2">
                    <div class="draggable-shape bg-white border-2 border-gray-300 rounded-lg p-3 text-center cursor-move hover:border-primary transition-colors" 
                         data-shape="rectangle">
                        <div class="w-8 h-6 bg-gray-200 mx-auto mb-1 rounded"></div>
                        <span class="text-xs text-gray-600">矩形</span>
                    </div>
                    <div class="draggable-shape bg-white border-2 border-gray-300 rounded-lg p-3 text-center cursor-move hover:border-primary transition-colors" 
                         data-shape="circle">
                        <div class="w-6 h-6 bg-gray-200 mx-auto mb-1 rounded-full"></div>
                        <span class="text-xs text-gray-600">圆形</span>
                    </div>
                    <div class="draggable-shape bg-white border-2 border-gray-300 rounded-lg p-3 text-center cursor-move hover:border-primary transition-colors" 
                         data-shape="triangle">
                        <div class="w-0 h-0 border-l-8 border-r-8 border-b-12 border-l-transparent border-r-transparent border-b-gray-200 mx-auto mb-1"></div>
                        <span class="text-xs text-gray-600">三角形</span>
                    </div>
                    <div class="draggable-shape bg-white border-2 border-gray-300 rounded-lg p-3 text-center cursor-move hover:border-primary transition-colors" 
                         data-shape="text">
                        <i class="fa fa-font text-gray-400 mb-1"></i>
                        <span class="text-xs text-gray-600">文本</span>
                    </div>
                    <div class="draggable-shape bg-white border-2 border-gray-300 rounded-lg p-3 text-center cursor-move hover:border-primary transition-colors" 
                         data-shape="line">
                        <div class="w-8 h-0.5 bg-gray-400 mx-auto mb-1"></div>
                        <span class="text-xs text-gray-600">直线</span>
                    </div>
                    <div class="draggable-shape bg-white border-2 border-gray-300 rounded-lg p-3 text-center cursor-move hover:border-primary transition-colors" 
                         data-shape="table">
                        <div class="w-8 h-6 mx-auto mb-1">
                            <div class="grid grid-cols-2 gap-0.5">
                                <div class="w-3.5 h-2.5 bg-gray-200"></div>
                                <div class="w-3.5 h-2.5 bg-gray-200"></div>
                                <div class="w-3.5 h-2.5 bg-gray-200"></div>
                                <div class="w-3.5 h-2.5 bg-gray-200"></div>
                            </div>
                        </div>
                        <span class="text-xs text-gray-600">表格</span>
                    </div>
                </div>
            </div>

            <!-- 插件图形 -->
            <div class="p-4 border-b border-gray-200">
                <h3 class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                    <i class="fa fa-puzzle-piece mr-2 text-secondary"></i>插件图形
                </h3>
                <div id="pluginShapes" class="grid grid-cols-2 gap-2">
                    <!-- 插件图形将在这里动态生成 -->
                </div>
            </div>

            <!-- 模板库 -->
            <div class="p-4">
                <h3 class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                    <i class="fa fa-folder-open mr-2 text-secondary"></i>模板库
                </h3>
                <div class="space-y-2">
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-2 cursor-pointer hover:border-primary transition-colors">
                        <div class="text-xs text-gray-600">快递单模板</div>
                    </div>
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-2 cursor-pointer hover:border-primary transition-colors">
                        <div class="text-xs text-gray-600">发票模板</div>
                    </div>
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-2 cursor-pointer hover:border-primary transition-colors">
                        <div class="text-xs text-gray-600">标签模板</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- 右侧画布区域 -->
        <main class="flex-1 flex flex-col overflow-hidden">
            <!-- 画布工具栏 -->
            <div class="bg-white border-b border-gray-200 px-4 py-2 flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2 text-sm text-gray-600">
                        <span>页面大小:</span>
                        <select id="pageSize" class="border border-gray-300 rounded px-2 py-1 text-sm focus:outline-none focus:ring-1 focus:ring-primary">
                            <option value="A4">A4</option>
                            <option value="A3">A3</option>
                            <option value="Letter">Letter</option>
                            <option value="Legal">Legal</option>
                        </select>
                    </div>
                    <div class="flex items-center space-x-2 text-sm text-gray-600">
                        <span>方向:</span>
                        <select id="pageOrientation" class="border border-gray-300 rounded px-2 py-1 text-sm focus:outline-none focus:ring-1 focus:ring-primary">
                            <option value="portrait">纵向</option>
                            <option value="landscape">横向</option>
                        </select>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2 text-sm text-gray-600">
                        <span>缩放:</span>
                        <button id="zoomOut" class="p-1 text-gray-600 hover:text-primary">
                            <i class="fa fa-search-minus"></i>
                        </button>
                        <span id="zoomLevel" class="w-12 text-center">100%</span>
                        <button id="zoomIn" class="p-1 text-gray-600 hover:text-primary">
                            <i class="fa fa-search-plus"></i>
                        </button>
                    </div>
                    <button id="gridToggle" class="px-3 py-1 text-sm border border-gray-300 rounded hover:border-primary hover:text-primary transition-colors">
                        <i class="fa fa-th mr-1"></i>网格
                    </button>
                </div>
            </div>

            <!-- 画布容器 -->
            <div class="flex-1 relative overflow-auto bg-gray-100">
                <div id="canvasContainer" class="absolute inset-0 flex items-center justify-center">
                    <!-- 画布 -->
                    <div id="canvas" class="relative bg-white shadow-lg grid-bg overflow-hidden" 
                         style="width: 210mm; height: 297mm; min-width: 210mm; min-height: 297mm;">
                        <!-- 设计元素将在这里动态添加 -->
                    </div>
                </div>
            </div>

            <!-- 属性面板 -->
            <div id="propertiesPanel" class="bg-white border-t border-gray-200 p-4 hidden">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-sm font-semibold text-gray-700">属性设置</h3>
                    <button id="closeProperties" class="text-gray-400 hover:text-gray-600">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                <div id="propertiesContent">
                    <!-- 属性内容将在这里动态生成 -->
                </div>
            </div>
        </main>
    </div>

    <!-- 打印预览模态框 -->
    <div id="printModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
            <div class="flex items-center justify-between border-b border-gray-200 p-4">
                <h3 class="text-lg font-semibold text-gray-800">打印预览</h3>
                <div class="flex items-center space-x-3">
                    <button id="modalPrintBtn" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                        <i class="fa fa-print mr-2"></i>打印
                    </button>
                    <button id="closePrintModal" class="text-gray-400 hover:text-gray-600">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="p-4 overflow-auto max-h-[calc(90vh-100px)]">
                <div id="printPreview" class="mx-auto bg-white shadow-lg" 
                     style="width: 210mm; height: 297mm;">
                    <!-- 打印内容将在这里生成 -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局状态管理
        const AppState = {
            elements: [],
            selectedElement: null,
            zoomLevel: 100,
            gridEnabled: true,
            plugins: {},
            history: [],
            historyIndex: -1,
            currentPageSize: 'A4',
            currentOrientation: 'portrait'
        };

        // 插件管理器
        class PluginManager {
            constructor() {
                this.plugins = {};
                this.eventBus = new EventBus();
            }

            registerPlugin(plugin) {
                if (!plugin.name || !plugin.init) {
                    console.error('插件必须包含name和init方法');
                    return;
                }

                try {
                    plugin.init(this.eventBus);
                    this.plugins[plugin.name] = plugin;
                    console.log(`插件 ${plugin.name} 注册成功`);
                    
                    // 如果插件有图形定义，添加到工具栏
                    if (plugin.shapes) {
                        this.addPluginShapes(plugin);
                    }

                    this.eventBus.emit('plugin.registered', plugin);
                } catch (error) {
                    console.error(`插件 ${plugin.name} 注册失败:`, error);
                }
            }

            addPluginShapes(plugin) {
                const pluginShapesContainer = document.getElementById('pluginShapes');
                
                plugin.shapes.forEach(shape => {
                    const shapeElement = document.createElement('div');
                    shapeElement.className = 'draggable-shape bg-white border-2 border-gray-300 rounded-lg p-3 text-center cursor-move hover:border-primary transition-colors';
                    shapeElement.dataset.shape = shape.type;
                    shapeElement.dataset.plugin = plugin.name;
                    
                    shapeElement.innerHTML = `
                        <div class="w-8 h-6 bg-gray-200 mx-auto mb-1 rounded"></div>
                        <span class="text-xs text-gray-600">${shape.name}</span>
                    `;
                    
                    pluginShapesContainer.appendChild(shapeElement);
                });
            }

            getPlugin(pluginName) {
                return this.plugins[pluginName];
            }

            getAllPlugins() {
                return Object.values(this.plugins);
            }
        }

        // 事件总线
        class EventBus {
            constructor() {
                this.events = {};
            }

            on(eventName, callback) {
                if (!this.events[eventName]) {
                    this.events[eventName] = [];
                }
                this.events[eventName].push(callback);
            }

            emit(eventName, data) {
                if (this.events[eventName]) {
                    this.events[eventName].forEach(callback => callback(data));
                }
            }

            off(eventName, callback) {
                if (this.events[eventName]) {
                    this.events[eventName] = this.events[eventName].filter(cb => cb !== callback);
                }
            }
        }

        // 图形元素管理器
        class ElementManager {
            constructor(canvas) {
                this.canvas = canvas;
                this.elements = [];
                this.nextId = 1;
            }

            createElement(shapeType, x = 100, y = 100, width = 100, height = 60) {
                const elementId = `element-${this.nextId++}`;
                
                const element = {
                    id: elementId,
                    type: shapeType,
                    x,
                    y,
                    width,
                    height,
                    rotation: 0,
                    fill: '#ffffff',
                    stroke: '#333333',
                    strokeWidth: 1,
                    opacity: 1,
                    text: shapeType === 'text' ? '文本内容' : '',
                    fontSize: 14,
                    fontFamily: 'Arial',
                    fontWeight: 'normal',
                    textAlign: 'center',
                    plugin: null
                };

                this.elements.push(element);
                this.renderElement(element);
                this.saveHistory();
                
                return element;
            }

            createPluginElement(pluginName, shapeType, x = 100, y = 100) {
                const plugin = pluginManager.getPlugin(pluginName);
                if (!plugin || !plugin.createElement) {
                    console.error('插件或插件的createElement方法不存在');
                    return null;
                }

                const elementId = `element-${this.nextId++}`;
                const element = plugin.createElement(elementId, shapeType, x, y);
                
                if (element) {
                    element.plugin = pluginName;
                    this.elements.push(element);
                    this.renderElement(element);
                    this.saveHistory();
                    return element;
                }
                
                return null;
            }

            renderElement(element) {
                const elementDiv = document.createElement('div');
                elementDiv.id = element.id;
                elementDiv.className = 'absolute select-none cursor-move transition-all duration-150';
                elementDiv.dataset.id = element.id;
                
                // 设置基本样式
                elementDiv.style.left = `${element.x}px`;
                elementDiv.style.top = `${element.y}px`;
                elementDiv.style.width = `${element.width}px`;
                elementDiv.style.height = `${element.height}px`;
                elementDiv.style.transform = `rotate(${element.rotation}deg)`;
                elementDiv.style.opacity = element.opacity;
                elementDiv.style.zIndex = 10;

                // 根据元素类型渲染不同内容
                switch (element.type) {
                    case 'rectangle':
                        this.renderRectangle(elementDiv, element);
                        break;
                    case 'circle':
                        this.renderCircle(elementDiv, element);
                        break;
                    case 'triangle':
                        this.renderTriangle(elementDiv, element);
                        break;
                    case 'text':
                        this.renderText(elementDiv, element);
                        break;
                    case 'line':
                        this.renderLine(elementDiv, element);
                        break;
                    case 'table':
                        this.renderTable(elementDiv, element);
                        break;
                    default:
                        // 检查是否是插件元素
                        if (element.plugin) {
                            const plugin = pluginManager.getPlugin(element.plugin);
                            if (plugin && plugin.renderElement) {
                                plugin.renderElement(elementDiv, element);
                            } else {
                                this.renderDefault(elementDiv, element);
                            }
                        } else {
                            this.renderDefault(elementDiv, element);
                        }
                }

                // 添加缩放手柄
                this.addResizeHandles(elementDiv);

                // 添加事件监听器
                this.addElementEvents(elementDiv, element);

                this.canvas.appendChild(elementDiv);
                return elementDiv;
            }

            renderRectangle(elementDiv, element) {
                elementDiv.style.backgroundColor = element.fill;
                elementDiv.style.border = `${element.strokeWidth}px solid ${element.stroke}`;
                elementDiv.style.borderRadius = '4px';
            }

            renderCircle(elementDiv, element) {
                elementDiv.style.backgroundColor = element.fill;
                elementDiv.style.border = `${element.strokeWidth}px solid ${element.stroke}`;
                elementDiv.style.borderRadius = '50%';
                elementDiv.style.width = `${element.width}px`;
                elementDiv.style.height = `${element.width}px`; // 保持圆形
            }

            renderTriangle(elementDiv, element) {
                elementDiv.style.backgroundColor = 'transparent';
                elementDiv.style.border = 'none';
                elementDiv.style.width = '0';
                elementDiv.style.height = '0';
                elementDiv.style.borderLeft = `${element.width/2}px solid transparent`;
                elementDiv.style.borderRight = `${element.width/2}px solid transparent`;
                elementDiv.style.borderBottom = `${element.height}px solid ${element.fill}`;
            }

            renderText(elementDiv, element) {
                elementDiv.style.backgroundColor = 'transparent';
                elementDiv.style.border = 'none';
                elementDiv.style.display = 'flex';
                elementDiv.style.alignItems = 'center';
                elementDiv.style.justifyContent = 'center';
                elementDiv.style.fontSize = `${element.fontSize}px`;
                elementDiv.style.fontFamily = element.fontFamily;
                elementDiv.style.fontWeight = element.fontWeight;
                elementDiv.style.textAlign = element.textAlign;
                elementDiv.style.color = element.stroke;
                elementDiv.contentEditable = true;
                elementDiv.textContent = element.text;
            }

            renderLine(elementDiv, element) {
                elementDiv.style.backgroundColor = 'transparent';
                elementDiv.style.border = 'none';
                elementDiv.style.width = '100%';
                elementDiv.style.height = `${element.strokeWidth}px`;
                elementDiv.style.backgroundColor = element.stroke;
                elementDiv.style.transformOrigin = 'left center';
            }

            renderTable(elementDiv, element) {
                elementDiv.style.backgroundColor = 'transparent';
                elementDiv.style.border = 'none';
                elementDiv.innerHTML = `
                    <div class="w-full h-full border-collapse">
                        <table class="w-full h-full border border-gray-300">
                            <tr>
                                <td class="border border-gray-300 text-xs p-1">单元格1</td>
                                <td class="border border-gray-300 text-xs p-1">单元格2</td>
                            </tr>
                            <tr>
                                <td class="border border-gray-300 text-xs p-1">单元格3</td>
                                <td class="border border-gray-300 text-xs p-1">单元格4</td>
                            </tr>
                        </table>
                    </div>
                `;
            }

            renderDefault(elementDiv, element) {
                elementDiv.style.backgroundColor = element.fill || '#f0f0f0';
                elementDiv.style.border = `${element.strokeWidth || 1}px solid ${element.stroke || '#999'}`;
                elementDiv.style.display = 'flex';
                elementDiv.style.alignItems = 'center';
                elementDiv.style.justifyContent = 'center';
                elementDiv.style.color = '#666';
                elementDiv.style.fontSize = '12px';
                elementDiv.textContent = element.type;
            }

            addResizeHandles(elementDiv) {
                const handles = ['tl', 'tr', 'bl', 'br'];
                handles.forEach(handle => {
                    const handleDiv = document.createElement('div');
                    handleDiv.className = `resize-handle resize-handle-${handle}`;
                    handleDiv.dataset.handle = handle;
                    elementDiv.appendChild(handleDiv);
                });
            }

            addElementEvents(elementDiv, element) {
                // 点击选中
                elementDiv.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.selectElement(element.id);
                });

                // 文本编辑
                if (element.type === 'text') {
                    elementDiv.addEventListener('input', (e) => {
                        element.text = e.target.textContent;
                        this.saveHistory();
                    });
                }
            }

            selectElement(elementId) {
                // 取消之前的选中
                if (AppState.selectedElement) {
                    const prevElement = document.getElementById(AppState.selectedElement);
                    if (prevElement) {
                        prevElement.classList.remove('element-selected');
                    }
                }

                // 选中新元素
                AppState.selectedElement = elementId;
                const element = document.getElementById(elementId);
                if (element) {
                    element.classList.add('element-selected');
                    this.showPropertiesPanel(elementId);
                }
            }

            showPropertiesPanel(elementId) {
                const panel = document.getElementById('propertiesPanel');
                const content = document.getElementById('propertiesContent');
                const element = this.elements.find(el => el.id === elementId);
                
                if (!element) return;

                content.innerHTML = this.generatePropertiesHTML(element);
                panel.classList.remove('hidden');
            }

            generatePropertiesHTML(element) {
                const elementData = this.elements.find(el => el.id === element.id);
                
                let html = `
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">位置和大小</label>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-xs text-gray-600 mb-1">X:</label>
                                    <input type="number" value="${element.x}" 
                                           class="w-full border border-gray-300 rounded px-2 py-1 text-sm"
                                           onchange="elementManager.updateElementProperty('${element.id}', 'x', parseInt(this.value))">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-600 mb-1">Y:</label>
                                    <input type="number" value="${element.y}" 
                                           class="w-full border border-gray-300 rounded px-2 py-1 text-sm"
                                           onchange="elementManager.updateElementProperty('${element.id}', 'y', parseInt(this.value))">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-600 mb-1">宽度:</label>
                                    <input type="number" value="${element.width}" 
                                           class="w-full border border-gray-300 rounded px-2 py-1 text-sm"
                                           onchange="elementManager.updateElementProperty('${element.id}', 'width', parseInt(this.value))">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-600 mb-1">高度:</label>
                                    <input type="number" value="${element.height}" 
                                           class="w-full border border-gray-300 rounded px-2 py-1 text-sm"
                                           onchange="elementManager.updateElementProperty('${element.id}', 'height', parseInt(this.value))">
                                </div>
                            </div>
                        </div>
                `;

                // 根据元素类型添加特定属性
                if (element.type !== 'line') {
                    html += `
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">样式</label>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-xs text-gray-600 mb-1">填充色:</label>
                                    <input type="color" value="${element.fill}" 
                                           class="w-full border border-gray-300 rounded px-2 py-1 text-sm"
                                           onchange="elementManager.updateElementProperty('${element.id}', 'fill', this.value)">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-600 mb-1">边框色:</label>
                                    <input type="color" value="${element.stroke}" 
                                           class="w-full border border-gray-300 rounded px-2 py-1 text-sm"
                                           onchange="elementManager.updateElementProperty('${element.id}', 'stroke', this.value)">
                                </div>
                            </div>
                        </div>
                    `;
                }

                if (element.type === 'text') {
                    html += `
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">文本属性</label>
                            <div class="space-y-2">
                                <div>
                                    <label class="block text-xs text-gray-600 mb-1">字体大小:</label>
                                    <input type="number" value="${element.fontSize}" 
                                           class="w-full border border-gray-300 rounded px-2 py-1 text-sm"
                                           onchange="elementManager.updateElementProperty('${element.id}', 'fontSize', parseInt(this.value))">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-600 mb-1">字体:</label>
                                    <select class="w-full border border-gray-300 rounded px-2 py-1 text-sm"
                                            onchange="elementManager.updateElementProperty('${element.id}', 'fontFamily', this.value)">
                                        <option value="Arial" ${element.fontFamily === 'Arial' ? 'selected' : ''}>Arial</option>
                                        <option value="Times New Roman" ${element.fontFamily === 'Times New Roman' ? 'selected' : ''}>Times New Roman</option>
                                        <option value="Courier New" ${element.fontFamily === 'Courier New' ? 'selected' : ''}>Courier New</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    `;
                }

                html += `
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">操作</label>
                            <button onclick="elementManager.deleteElement('${element.id}')" 
                                    class="w-full bg-danger text-white text-xs py-1 rounded hover:bg-danger/90 transition-colors">
                                <i class="fa fa-trash mr-1"></i>删除
                            </button>
                        </div>
                    </div>
                `;

                return html;
            }

            updateElementProperty(elementId, property, value) {
                const element = this.elements.find(el => el.id === elementId);
                const elementDiv = document.getElementById(elementId);
                
                if (element && elementDiv) {
                    element[property] = value;
                    
                    // 更新DOM
                    switch (property) {
                        case 'x':
                        case 'y':
                            elementDiv.style[property] = `${value}px`;
                            break;
                        case 'width':
                        case 'height':
                            elementDiv.style[property] = `${value}px`;
                            if (element.type === 'circle') {
                                elementDiv.style.height = `${value}px`; // 保持圆形
                            }
                            break;
                        case 'fill':
                        case 'stroke':
                        case 'strokeWidth':
                            this.updateElementStyle(elementDiv, element);
                            break;
                        case 'fontSize':
                        case 'fontFamily':
                        case 'fontWeight':
                            if (element.type === 'text') {
                                elementDiv.style[property] = property === 'fontSize' ? `${value}px` : value;
                            }
                            break;
                    }
                    
                    this.saveHistory();
                }
            }

            updateElementStyle(elementDiv, element) {
                switch (element.type) {
                    case 'rectangle':
                        elementDiv.style.backgroundColor = element.fill;
                        elementDiv.style.border = `${element.strokeWidth}px solid ${element.stroke}`;
                        break;
                    case 'circle':
                        elementDiv.style.backgroundColor = element.fill;
                        elementDiv.style.border = `${element.strokeWidth}px solid ${element.stroke}`;
                        break;
                    case 'triangle':
                        elementDiv.style.borderBottom = `${element.height}px solid ${element.fill}`;
                        break;
                    case 'text':
                        elementDiv.style.color = element.stroke;
                        break;
                    case 'line':
                        elementDiv.style.backgroundColor = element.stroke;
                        elementDiv.style.height = `${element.strokeWidth}px`;
                        break;
                }
            }

            deleteElement(elementId) {
                const index = this.elements.findIndex(el => el.id === elementId);
                if (index !== -1) {
                    this.elements.splice(index, 1);
                    
                    const elementDiv = document.getElementById(elementId);
                    if (elementDiv) {
                        elementDiv.remove();
                    }
                    
                    if (AppState.selectedElement === elementId) {
                        AppState.selectedElement = null;
                        document.getElementById('propertiesPanel').classList.add('hidden');
                    }
                    
                    this.saveHistory();
                }
            }

            saveHistory() {
                // 移除当前位置之后的历史
                if (AppState.historyIndex < AppState.history.length - 1) {
                    AppState.history.splice(AppState.historyIndex + 1);
                }
                
                // 保存当前状态
                const currentState = JSON.stringify(this.elements);
                AppState.history.push(currentState);
                AppState.historyIndex = AppState.history.length - 1;
                
                // 限制历史记录数量
                if (AppState.history.length > 50) {
                    AppState.history.shift();
                    AppState.historyIndex--;
                }
            }

            undo() {
                if (AppState.historyIndex > 0) {
                    AppState.historyIndex--;
                    this.restoreState(AppState.history[AppState.historyIndex]);
                }
            }

            redo() {
                if (AppState.historyIndex < AppState.history.length - 1) {
                    AppState.historyIndex++;
                    this.restoreState(AppState.history[AppState.historyIndex]);
                }
            }

            restoreState(state) {
                // 清除当前元素
                this.canvas.innerHTML = '';
                
                // 恢复状态
                this.elements = JSON.parse(state);
                
                // 重新渲染元素
                this.elements.forEach(element => {
                    this.renderElement(element);
                });
                
                // 恢复选中状态
                if (AppState.selectedElement) {
                    const element = document.getElementById(AppState.selectedElement);
                    if (element) {
                        element.classList.add('element-selected');
                    }
                }
            }
        }

        // 初始化应用
        let pluginManager;
        let elementManager;

        function initApp() {
            // 初始化插件管理器
            pluginManager = new PluginManager();
            
            // 初始化元素管理器
            const canvas = document.getElementById('canvas');
            elementManager = new ElementManager(canvas);
            
            // 初始化拖拽功能
            initDragAndDrop();
            
            // 初始化事件监听器
            initEventListeners();
            
            // 注册内置插件示例
            registerBuiltinPlugins();
            
            console.log('打印模板设计器初始化完成');
        }

        // 初始化拖拽和缩放
        function initDragAndDrop() {
            // 左侧工具栏图形拖拽到画布
            interact('.draggable-shape').draggable({
                inertia: true,
                modifiers: [
                    interact.modifiers.restrictRect({
                        restriction: 'parent',
                        endOnly: true
                    })
                ],
                autoScroll: true,
                listeners: {
                    move(event) {
                        const target = event.target;
                        const x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
                        const y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;
                        
                        target.style.transform = `translate(${x}px, ${y}px)`;
                        target.setAttribute('data-x', x);
                        target.setAttribute('data-y', y);
                    },
                    end(event) {
                        const target = event.target;
                        const shapeType = target.dataset.shape;
                        const pluginName = target.dataset.plugin;
                        
                        // 重置样式
                        target.style.transform = '';
                        target.removeAttribute('data-x');
                        target.removeAttribute('data-y');
                        
                        // 获取画布位置
                        const canvas = document.getElementById('canvas');
                        const canvasRect = canvas.getBoundingClientRect();
                        const dropX = event.pageX - canvasRect.left;
                        const dropY = event.pageY - canvasRect.top;
                        
                        // 创建元素
                        if (pluginName) {
                            elementManager.createPluginElement(pluginName, shapeType, dropX, dropY);
                        } else {
                            elementManager.createElement(shapeType, dropX, dropY);
                        }
                    }
                }
            });

            // 画布元素拖拽
            interact('#canvas .absolute').draggable({
                inertia: true,
                modifiers: [
                    interact.modifiers.restrictRect({
                        restriction: '#canvas',
                        endOnly: true
                    })
                ],
                autoScroll: true,
                listeners: {
                    start(event) {
                        const elementId = event.target.dataset.id;
                        elementManager.selectElement(elementId);
                    },
                    move(event) {
                        const target = event.target;
                        const elementId = target.dataset.id;
                        const element = elementManager.elements.find(el => el.id === elementId);
                        
                        if (element) {
                            element.x += event.dx;
                            element.y += event.dy;
                            
                            target.style.left = `${element.x}px`;
                            target.style.top = `${element.y}px`;
                        }
                    },
                    end(event) {
                        elementManager.saveHistory();
                    }
                }
            });

            // 元素缩放
            interact('#canvas .absolute').resizable({
                edges: {
                    left: '.resize-handle-tl, .resize-handle-bl',
                    right: '.resize-handle-tr, .resize-handle-br',
                    top: '.resize-handle-tl, .resize-handle-tr',
                    bottom: '.resize-handle-bl, .resize-handle-br'
                },
                modifiers: [
                    interact.modifiers.restrictSize({
                        min: { width: 20, height: 20 }
                    })
                ],
                listeners: {
                    move(event) {
                        const target = event.target;
                        const elementId = target.dataset.id;
                        const element = elementManager.elements.find(el => el.id === elementId);
                        
                        if (element) {
                            // 更新位置和大小
                            element.x = event.rect.left;
                            element.y = event.rect.top;
                            element.width = event.rect.width;
                            element.height = event.rect.height;
                            
                            // 更新DOM
                            target.style.left = `${element.x}px`;
                            target.style.top = `${element.y}px`;
                            target.style.width = `${element.width}px`;
                            target.style.height = `${element.height}px`;
                            
                            // 特殊处理圆形
                            if (element.type === 'circle') {
                                target.style.height = `${element.width}px`;
                                element.height = element.width;
                            }
                        }
                    },
                    end(event) {
                        elementManager.saveHistory();
                    }
                }
            });
        }

        // 初始化事件监听器
        function initEventListeners() {
            // 画布点击取消选中
            document.getElementById('canvas').addEventListener('click', () => {
                if (AppState.selectedElement) {
                    const element = document.getElementById(AppState.selectedElement);
                    if (element) {
                        element.classList.remove('element-selected');
                    }
                    AppState.selectedElement = null;
                    document.getElementById('propertiesPanel').classList.add('hidden');
                }
            });

            // 关闭属性面板
            document.getElementById('closeProperties').addEventListener('click', () => {
                document.getElementById('propertiesPanel').classList.add('hidden');
            });

            // 撤销重做
            document.getElementById('undoBtn').addEventListener('click', () => {
                elementManager.undo();
            });

            document.getElementById('redoBtn').addEventListener('click', () => {
                elementManager.redo();
            });

            // 保存模板
            document.getElementById('saveBtn').addEventListener('click', () => {
                const templateData = {
                    elements: elementManager.elements,
                    pageSize: AppState.currentPageSize,
                    orientation: AppState.currentOrientation,
                    timestamp: new Date().toISOString()
                };
                
                const templateString = JSON.stringify(templateData, null, 2);
                const blob = new Blob([templateString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `template-${new Date().getTime()}.json`;
                a.click();
                
                URL.revokeObjectURL(url);
            });

            // 打印预览
            document.getElementById('printBtn').addEventListener('click', showPrintPreview);
            document.getElementById('closePrintModal').addEventListener('click', hidePrintPreview);
            document.getElementById('modalPrintBtn').addEventListener('click', () => {
                window.print();
            });

            // 页面大小和方向
            document.getElementById('pageSize').addEventListener('change', (e) => {
                AppState.currentPageSize = e.target.value;
                updateCanvasSize();
            });

            document.getElementById('pageOrientation').addEventListener('change', (e) => {
                AppState.currentOrientation = e.target.value;
                updateCanvasSize();
            });

            // 缩放控制
            document.getElementById('zoomIn').addEventListener('click', () => {
                AppState.zoomLevel = Math.min(200, AppState.zoomLevel + 10);
                updateZoom();
            });

            document.getElementById('zoomOut').addEventListener('click', () => {
                AppState.zoomLevel = Math.max(50, AppState.zoomLevel - 10);
                updateZoom();
            });

            // 网格切换
            document.getElementById('gridToggle').addEventListener('click', () => {
                AppState.gridEnabled = !AppState.gridEnabled;
                const canvas = document.getElementById('canvas');
                if (AppState.gridEnabled) {
                    canvas.classList.add('grid-bg');
                } else {
                    canvas.classList.remove('grid-bg');
                }
            });
        }

        // 更新画布大小
        function updateCanvasSize() {
            const canvas = document.getElementById('canvas');
            const sizes = {
                'A4': { width: 210, height: 297 },
                'A3': { width: 297, height: 420 },
                'Letter': { width: 216, height: 279 },
                'Legal': { width: 216, height: 356 }
            };

            const size = sizes[AppState.currentPageSize];
            let width = size.width;
            let height = size.height;

            if (AppState.currentOrientation === 'landscape') {
                [width, height] = [height, width];
            }

            canvas.style.width = `${width}mm`;
            canvas.style.height = `${height}mm`;
            canvas.style.minWidth = `${width}mm`;
            canvas.style.minHeight = `${height}mm`;
        }

        // 更新缩放
        function updateZoom() {
            const canvasContainer = document.getElementById('canvasContainer');
            const zoomLevel = document.getElementById('zoomLevel');
            
            zoomLevel.textContent = `${AppState.zoomLevel}%`;
            canvasContainer.style.transform = `scale(${AppState.zoomLevel / 100})`;
            canvasContainer.style.transformOrigin = 'top left';
        }

        // 打印预览
        function showPrintPreview() {
            const modal = document.getElementById('printModal');
            const preview = document.getElementById('printPreview');
            
            // 清空预览
            preview.innerHTML = '';
            
            // 复制画布内容
            const canvas = document.getElementById('canvas');
            const canvasClone = canvas.cloneNode(true);
            canvasClone.className = 'bg-white';
            canvasClone.style.width = canvas.style.width;
            canvasClone.style.height = canvas.style.height;
            
            preview.appendChild(canvasClone);
            modal.classList.remove('hidden');
        }

        function hidePrintPreview() {
            const modal = document.getElementById('printModal');
            modal.classList.add('hidden');
        }

        // 注册内置插件示例
        function registerBuiltinPlugins() {
            // 条形码插件
            const barcodePlugin = {
                name: 'barcode',
                shapes: [
                    {
                        type: 'barcode',
                        name: '条形码'
                    }
                ],
                init(eventBus) {
                    console.log('条形码插件初始化');
                    
                    // 监听事件
                    eventBus.on('element.selected', (element) => {
                        if (element.type === 'barcode') {
                            console.log('条形码元素被选中');
                        }
                    });
                },
                createElement(elementId, shapeType, x, y) {
                    return {
                        id: elementId,
                        type: 'barcode',
                        x,
                        y,
                        width: 200,
                        height: 60,
                        fill: '#ffffff',
                        stroke: '#000000',
                        strokeWidth: 1,
                        value: '123456789012',
                        format: 'code128'
                    };
                },
                renderElement(elementDiv, element) {
                    elementDiv.style.backgroundColor = element.fill;
                    elementDiv.style.border = `${element.strokeWidth}px solid ${element.stroke}`;
                    elementDiv.style.display = 'flex';
                    elementDiv.style.flexDirection = 'column';
                    elementDiv.style.alignItems = 'center';
                    elementDiv.style.justifyContent = 'center';
                    elementDiv.style.padding = '10px';
                    
                    // 模拟条形码
                    const barcodeLines = document.createElement('div');
                    barcodeLines.style.display = 'flex';
                    barcodeLines.style.alignItems = 'stretch';
                    barcodeLines.style.height = '30px';
                    barcodeLines.style.marginBottom = '5px';
                    
                    // 创建模拟的条形码线条
                    for (let i = 0; i < 20; i++) {
                        const line = document.createElement('div');
                        line.style.width = `${Math.random() * 3 + 1}px`;
                        line.style.backgroundColor = element.stroke;
                        line.style.marginRight = '1px';
                        barcodeLines.appendChild(line);
                    }
                    
                    const text = document.createElement('div');
                    text.style.fontFamily = 'monospace';
                    text.style.fontSize = '12px';
                    text.style.color = element.stroke;
                    text.textContent = element.value;
                    
                    elementDiv.appendChild(barcodeLines);
                    elementDiv.appendChild(text);
                }
            };

            // 二维码插件
            const qrcodePlugin = {
                name: 'qrcode',
                shapes: [
                    {
                        type: 'qrcode',
                        name: '二维码'
                    }
                ],
                init(eventBus) {
                    console.log('二维码插件初始化');
                },
                createElement(elementId, shapeType, x, y) {
                    return {
                        id: elementId,
                        type: 'qrcode',
                        x,
                        y,
                        width: 120,
                        height: 120,
                        fill: '#ffffff',
                        stroke: '#000000',
                        strokeWidth: 1,
                        value: 'https://example.com'
                    };
                },
                renderElement(elementDiv, element) {
                    elementDiv.style.backgroundColor = element.fill;
                    elementDiv.style.border = `${element.strokeWidth}px solid ${element.stroke}`;
                    elementDiv.style.display = 'flex';
                    elementDiv.style.alignItems = 'center';
                    elementDiv.style.justifyContent = 'center';
                    
                    // 模拟二维码
                    const qrGrid = document.createElement('div');
                    qrGrid.style.display = 'grid';
                    qrGrid.style.gridTemplateColumns = 'repeat(21, 1fr)';
                    qrGrid.style.gridTemplateRows = 'repeat(21, 1fr)';
                    qrGrid.style.width = '100px';
                    qrGrid.style.height = '100px';
                    
                    // 创建模拟的二维码点阵
                    for (let i = 0; i < 21; i++) {
                        for (let j = 0; j < 21; j++) {
                            const dot = document.createElement('div');
                            // 模拟二维码的定位图案和随机数据
                            const isPositionPattern = (i < 7 && j < 7) || (i < 7 && j > 13) || (i > 13 && j < 7);
                            const isData = Math.random() > 0.5;
                            
                            if (isPositionPattern || isData) {
                                dot.style.backgroundColor = element.stroke;
                            }
                            
                            qrGrid.appendChild(dot);
                        }
                    }
                    
                    elementDiv.appendChild(qrGrid);
                }
            };

            // 注册插件
            pluginManager.registerPlugin(barcodePlugin);
            pluginManager.registerPlugin(qrcodePlugin);
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', initApp);

        // 全局变量供属性面板使用
        window.elementManager = elementManager;
    </script>
</body>
</html>
```